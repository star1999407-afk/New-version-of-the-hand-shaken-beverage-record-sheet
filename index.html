<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹æ–æˆç™®æ‚£è€…è‡¨åºŠè¨ºæ–·ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFCF8;
            background-image: linear-gradient(#E0D8C8 1px, transparent 1px);
            background-size: 100% 28px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes trophy-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-12px) rotate(2deg); }
        }
        .trophy-anim { animation: trophy-float 3s ease-in-out infinite; }

        .snow-particle {
            position: fixed;
            top: -20px;
            pointer-events: none;
            z-index: 10000;
            animation: snow-fall linear forwards;
        }
        @keyframes snow-fall {
            0% { transform: translateY(0) rotate(0deg) translateX(0); opacity: 1; }
            100% { transform: translateY(105vh) rotate(720deg) translateX(var(--drift)); opacity: 0; }
        }

        #sponsor-field {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transform: scale(0.95);
        }
        #sponsor-field.show {
            max-height: 120px;
            opacity: 1;
            margin-top: 1rem;
            transform: scale(1);
        }

        .active-tab { color: white !important; }
        .active-tab i { transform: scale(1.1); stroke-width: 3; }

        ::-webkit-scrollbar { display: none; }
        * { font-style: normal !important; }
        .tilt-header { transform: rotate(-2.5deg); font-style: normal !important; }
        
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-32">

    <div id="app" class="max-w-2xl mx-auto">
        <header class="mb-8 text-center pt-2">
            <span class="text-[10px] font-black text-[#6D4C41] tracking-[0.3em] uppercase mb-2 block opacity-70">Clinical Case Report</span>
            <div class="relative inline-block px-10 py-3 bg-white border-2 border-[#4E342E] rounded-2xl shadow-[6px_6px_0px_#D7CCC8] tilt-header">
                <h1 class="text-2xl font-black text-[#3E2723]">æ‰‹æ–æˆç™®æ‚£è€…ğŸ¥¤</h1>
                <div class="absolute -top-4 -right-4 text-amber-500"><i data-lucide="sparkles" size="22"></i></div>
            </div>
            <div class="mt-4">
                <span class="bg-[#3E2723] text-white text-[9px] font-mono px-3 py-1 rounded-full opacity-80 tracking-widest">PATIENT ID: #SH-2024-8892-XT</span>
            </div>
        </header>

        <div id="tab-content"></div>

        <!-- Navigation -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-lg bg-[#3E2723] p-1.5 rounded-[2rem] flex justify-between items-center shadow-2xl z-[110] border border-white/5">
            <button onclick="switchTab('prescribe')" id="btn-prescribe" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="pill" size="18"></i>
                <span class="text-[8px] font-black mt-1 uppercase">è¨ºæ–· / DX</span>
            </button>
            <button onclick="switchTab('calendar')" id="btn-calendar" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="calendar" size="18"></i>
                <span class="text-[8px] font-black mt-1 uppercase">æ—¥èªŒ / Log</span>
            </button>
            <button onclick="switchTab('history')" id="btn-history" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="history" size="18"></i>
                <span class="text-[8px] font-black mt-1 uppercase">ç´€éŒ„ / RX</span>
            </button>
            <button onclick="switchTab('statistics')" id="btn-statistics" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="bar-chart-3" size="18"></i>
                <span class="text-[8px] font-black mt-1 uppercase">åˆ†æ / Stats</span>
            </button>
            <button onclick="switchTab('reports')" id="btn-reports" class="flex-1 flex flex-col items-center py-2 text-[#A1887F] transition-all">
                <i data-lucide="file-text" size="18"></i>
                <span class="text-[8px] font-black mt-1 uppercase">å ±è¡¨ / File</span>
            </button>
        </nav>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('drink_records')) || [];
        let activeTab = 'prescribe';
        let editingIndex = null;
        
        let currentIce = 'å¾®å†°';
        let currentSugar = 'å¾®ç³–';
        let currentEco = false;
        let currentIns = false;
        
        const getToday = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        let currentDate = getToday();
        let calendarDate = new Date();

        function initIcons() { lucide.createIcons(); }

        function spawnSnowEffect() {
            const icons = ['ğŸƒ', 'ğŸ§ª', 'âœ¨', 'ğŸ’Š', 'ğŸ‹'];
            for (let i = 0; i < 40; i++) {
                setTimeout(() => {
                    const p = document.createElement('div');
                    p.className = 'snow-particle';
                    p.innerHTML = icons[Math.floor(Math.random() * icons.length)];
                    p.style.left = Math.random() * 100 + 'vw';
                    p.style.fontSize = Math.random() * 15 + 15 + 'px';
                    p.style.setProperty('--drift', (Math.random() - 0.5) * 200 + 'px');
                    const duration = Math.random() * 2 + 3;
                    p.style.animationDuration = duration + 's';
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), duration * 1000);
                }, i * 50);
            }
        }

        function saveRecords() {
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('drink_records', JSON.stringify(records));
            render();
        }

        function exportToCSV() {
            if (records.length === 0) { alert("ç›®å‰æ²’æœ‰ç—…ä¾‹ç´€éŒ„å¯ä»¥åŒ¯å‡º"); return; }
            let csvContent = "\uFEFF";
            csvContent += "æ—¥æœŸ,è¨ºç™‚æ‰€(åº—å®¶),è—¥åŠ‘(é£²å“),è¨ºå¯Ÿè²»,å†°é‡,ç³–åˆ†,ç’°ä¿æ¯,å¥ä¿ç”³å ±,è´ŠåŠ©äºº\n";
            records.forEach(r => {
                let row = [r.date, r.shop, r.drink, r.cost, r.ice, r.sugar, r.eco ? "æ˜¯" : "å¦", r.insurance ? "æ˜¯" : "å¦", r.sponsor || ""].join(",");
                csvContent += row + "\n";
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `æ‰‹æ–æˆç™®ç—…ä¾‹å ±å‘Š_${new Date().getFullYear()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(records));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "æ‰‹æ–ç—…ä¾‹åŸå§‹æ•¸æ“šå‚™ä»½.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function switchTab(tabId) {
            activeTab = tabId;
            if (activeTab === 'prescribe' && editingIndex === null) {
                currentDate = getToday();
                resetFormState();
            }
            render();
        }

        function resetFormState() {
            currentIce = 'å¾®å†°';
            currentSugar = 'å¾®ç³–';
            currentEco = false;
            currentIns = false;
            if (editingIndex === null) currentDate = getToday();
            editingIndex = null;
        }

        function changeCalendarMonth(offset) {
            calendarDate.setMonth(calendarDate.getMonth() + offset);
            render();
        }

        function getStats() {
            const now = new Date();
            const curMonth = now.toISOString().slice(0, 7);
            const monthly = records.filter(r => r.date.startsWith(curMonth));
            const shopCounts = {};
            records.forEach(r => shopCounts[r.shop] = (shopCounts[r.shop] || 0) + 1);
            const sortedShops = Object.entries(shopCounts).sort((a,b) => b[1]-a[1]);

            return {
                mDose: monthly.length,
                mCost: monthly.reduce((acc, r) => acc + (r.insurance ? 0 : parseInt(r.cost || 0)), 0),
                mEco: monthly.filter(r => r.eco).length,
                mIns: monthly.filter(r => r.insurance).length,
                topClinic: sortedShops[0]?.[0] || 'å°šæœªçœ‹è¨º',
                yDose: records.length,
                yCost: records.reduce((acc, r) => acc + (r.insurance ? 0 : parseInt(r.cost || 0)), 0),
                yWaste: records.filter(r => r.eco).length,
                yIns: records.filter(r => r.insurance).length,
                allShops: sortedShops
            };
        }

        function render() {
            const content = document.getElementById('tab-content');
            const stats = getStats();
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active-tab'));
            document.getElementById(`btn-${activeTab}`).classList.add('active-tab');

            if (activeTab === 'prescribe') {
                const isEditing = editingIndex !== null;
                const data = isEditing ? records[editingIndex] : null;
                content.innerHTML = `
                    <div class="space-y-5 animate-fadeIn">
                        <section class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            <div class="bg-yellow-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-yellow-200">
                                <p class="text-[8px] font-black uppercase text-yellow-800/60 leading-tight">ç•¶æœˆåŠ‘é‡<br><span class="opacity-40">Monthly Dose</span></p>
                                <span class="text-[13px] font-black text-yellow-900">${stats.mDose}æ¯</span>
                            </div>
                            <div class="bg-pink-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-pink-200">
                                <p class="text-[8px] font-black uppercase text-pink-800/60 leading-tight">ç•¶æœˆè¨ºç™‚è²»<br><span class="opacity-40">Monthly Fee</span></p>
                                <span class="text-[13px] font-black text-pink-900">$${stats.mCost}</span>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-blue-200">
                                <p class="text-[8px] font-black uppercase text-blue-800/60 leading-tight">å¥ä¿ç”³å ±<br><span class="opacity-40">Claim</span></p>
                                <span class="text-[13px] font-black text-blue-900">${stats.mIns}æ¯</span>
                            </div>
                            <div class="bg-emerald-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-emerald-200">
                                <p class="text-[8px] font-black uppercase text-emerald-800/60 leading-tight">å»¢æ£„ç‰©æ¸›å°‘<br><span class="opacity-40">Eco Save</span></p>
                                <span class="text-[13px] font-black text-emerald-900">${stats.mEco}ä»¶</span>
                            </div>
                            <div class="bg-violet-100 p-3 rounded-2xl text-center shadow-md border-b-4 border-violet-200 col-span-2 md:col-span-1">
                                <p class="text-[8px] font-black uppercase text-violet-800/60 leading-tight">æœ€æ„›è¨ºç™‚æ‰€<br><span class="opacity-40">Clinic</span></p>
                                <span class="text-[11px] font-black text-violet-900 truncate block px-1">${stats.topClinic}</span>
                            </div>
                        </section>
                        <section class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border-2 ${isEditing ? 'border-amber-400' : 'border-stone-200'}">
                            <div class="${isEditing ? 'bg-amber-600' : 'bg-[#3E2723]'} p-5 text-white flex justify-between items-center">
                                <div class="flex flex-col">
                                    <p class="text-[10px] font-black opacity-60 tracking-widest mb-1 uppercase">${isEditing ? 'ä¿®æ”¹ç—…ä¾‹ / Update Record' : 'è‡¨åºŠç—…ä¾‹è¡¨ / Prescription Form'}</p>
                                    <div class="flex items-center gap-2 relative">
                                        <input type="date" id="input-date" onchange="currentDate=this.value" value="${currentDate}" class="bg-white/10 px-2 py-0.5 rounded-lg font-bold text-lg outline-none text-white border-none cursor-pointer" />
                                        <i data-lucide="clock" size="16"></i>
                                    </div>
                                </div>
                                <i data-lucide="${isEditing ? 'pencil-line' : 'plus-circle'}" class="text-white/80"></i>
                            </div>
                            <div class="p-8 space-y-6">
                                <div class="space-y-2">
                                    <p class="text-[10px] font-black text-[#3E2723] uppercase tracking-wider">å†°é‡èª¿é… / Ice</p>
                                    <div class="option-grid">
                                        ${["å»å†°", "å¾®å†°", "å°‘å†°", "ç¢å†°", "æ­£å¸¸å†°", "ç†±", "å¸¸æº«", "ç„¡æ³•èª¿æ•´"].map(o => `
                                            <button onclick="setOption('ice', '${o}')" class="h-10 rounded-xl text-[10px] font-black border transition-all ${currentIce === o ? 'bg-[#3E2723] text-white border-[#3E2723]' : 'bg-white text-stone-600 border-stone-200'}">${o}</button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-[10px] font-black text-[#3E2723] uppercase tracking-wider">ç³–åˆ†è—¥åŠ› / Sugar</p>
                                    <div class="option-grid">
                                        ${["ç„¡ç³–", "ä¸€åˆ†", "å¾®ç³–", "åŠç³–", "å…¨ç³–", "ç„¡æ³•èª¿æ•´"].map(o => `
                                            <button onclick="setOption('sugar', '${o}')" class="h-10 rounded-xl text-[10px] font-black border transition-all ${currentSugar === o ? 'bg-[#D84315] text-white border-[#D84315]' : 'bg-white text-stone-600 border-stone-200'}">${o}</button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase">ç’°ä¿æ¯</p>
                                        <div class="flex gap-2">
                                            <button onclick="setOption('eco', true)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${currentEco ? 'bg-emerald-700 text-white border-emerald-700' : 'bg-white text-stone-400 border-stone-200'}">æœ‰</button>
                                            <button onclick="setOption('eco', false)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${!currentEco ? 'bg-stone-500 text-white border-stone-500' : 'bg-white text-stone-400 border-stone-200'}">ç„¡</button>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase">å¥ä¿ç”³å ± (æœ‰äººè«‹å®¢)</p>
                                        <div class="flex gap-2">
                                            <button onclick="setOption('ins', true)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${currentIns ? 'bg-blue-700 text-white border-blue-700' : 'bg-white text-stone-400 border-stone-200'}">æœ‰</button>
                                            <button onclick="setOption('ins', false)" class="flex-1 py-2 rounded-xl text-[10px] font-black border ${!currentIns ? 'bg-stone-500 text-white border-stone-500' : 'bg-white text-stone-400 border-stone-200'}">ç„¡</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="sponsor-field" class="${currentIns ? 'show' : ''}">
                                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                                        <p class="text-[10px] font-black text-blue-800 uppercase mb-2 flex items-center gap-1">
                                            <i data-lucide="gift" size="12"></i> è´ŠåŠ©äººå§“å / Sponsor Name
                                        </p>
                                        <input type="text" id="input-sponsor" value="${isEditing ? (data.sponsor || '') : ''}" placeholder="æ˜¯èª°è«‹å®¢çš„å‘¢ï¼Ÿ" class="w-full bg-white border border-blue-200 p-3 rounded-xl font-bold text-sm outline-none shadow-sm focus:ring-2 focus:ring-blue-400" />
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-stone-100">
                                    <div class="space-y-1.5">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase">è¨ºç™‚æ‰€ / Clinic</p>
                                        <input type="text" id="input-shop" value="${isEditing ? data.shop : ''}" placeholder="è¨ºæ‰€åç¨±..." class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" />
                                    </div>
                                    <div class="space-y-1.5">
                                        <p class="text-[10px] font-black text-[#3E2723] uppercase">è—¥åŠ‘åç¨± / Drink</p>
                                        <input type="text" id="input-drink" value="${isEditing ? data.drink : ''}" placeholder="è—¥æ°´åç¨±..." class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" />
                                    </div>
                                </div>
                                <div class="space-y-1.5">
                                    <p class="text-[10px] font-black text-[#3E2723] uppercase">${currentIns ? 'è¨ºå¯Ÿè²» (è´ŠåŠ©é‡‘é¡)' : 'è¨ºå¯Ÿè²» / Fee'}</p>
                                    <input type="number" id="input-cost" value="${isEditing ? data.cost : ''}" placeholder="NT$" class="w-full bg-stone-50 border border-stone-200 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" />
                                    ${currentIns ? '<p class="text-[9px] text-blue-600 font-bold mt-1 tracking-wider">* å¥ä¿æ¡ˆä»¶é‡‘é¡å°‡ç´€éŒ„ç‚ºè´ŠåŠ©ï¼Œä¸è¨ˆå…¥å€‹äººå¹´åº¦æ”¯å‡º</p>' : ''}
                                </div>
                                <div class="flex gap-3">
                                    ${isEditing ? `<button onclick="cancelEdit()" class="flex-1 bg-stone-100 text-stone-600 py-4 rounded-2xl font-black text-lg active:scale-95 transition-all">å–æ¶ˆ</button>` : ''}
                                    <button onclick="saveCurrentRecord()" class="${isEditing ? 'flex-[2] bg-amber-600' : 'w-full bg-[#3E2723]'} text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">
                                        ${isEditing ? 'ç¢ºèªä¿®æ”¹ / Update' : 'é–‹ç«‹è™•æ–¹ / Confirm'}
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>`;
            } else if (activeTab === 'history') {
                content.innerHTML = `
                    <div class="space-y-4 animate-fadeIn">
                        <h2 class="text-xl font-black text-[#3E2723] px-2 flex items-center gap-2"><i data-lucide="history"></i> è¨ºæ–·ç´€éŒ„åº« / RX</h2>
                        ${records.length === 0 ? '<div class="text-center py-20 bg-white rounded-3xl border border-dashed opacity-40 text-xs uppercase font-black">ç›®å‰æš«ç„¡ç—…ä¾‹è³‡æ–™</div>' : records.map((r, i) => `
                            <div class="bg-white p-5 rounded-[1.8rem] border border-stone-200 shadow-sm flex justify-between items-center transition-all hover:shadow-md">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[9px] font-black text-white bg-[#3E2723] px-2 py-0.5 rounded uppercase">${r.date}</span>
                                        ${r.eco ? '<span class="flex items-center gap-0.5 text-[8px] font-black text-emerald-700 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100"><i data-lucide="leaf" size="8"></i>ç’°ä¿æ¯</span>' : ''}
                                        ${r.insurance ? `<span class="flex items-center gap-0.5 text-[8px] font-black text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100"><i data-lucide="gift" size="8"></i>${r.sponsor || 'è´ŠåŠ©'}</span>` : ''}
                                    </div>
                                    <h4 class="font-black text-[#3E2723] text-base">${r.shop}</h4>
                                    <p class="text-xs font-bold text-stone-500">${r.drink} Â· ${r.sugar} Â· ${r.ice}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex flex-col items-end mr-2">
                                        ${r.insurance ? `
                                            <span class="text-[10px] font-black text-blue-500 uppercase tracking-tighter">FREE</span>
                                            <span class="text-sm font-black text-blue-400">($${r.cost})</span>
                                        ` : `
                                            <span class="text-xl font-black text-[#3E2723]">$${r.cost}</span>
                                        `}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="editRecord(${i})" class="p-2 text-stone-300 hover:text-amber-600 transition-colors"><i data-lucide="pencil" size="18"></i></button>
                                        <button onclick="deleteRecord(${i})" class="p-2 text-red-200 hover:text-red-600 transition-colors"><i data-lucide="trash-2" size="18"></i></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (activeTab === 'calendar') {
                const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                content.innerHTML = `
                    <div class="bg-white p-6 md:p-10 rounded-[2.5rem] border border-stone-200 shadow-lg animate-fadeIn">
                        <div class="flex justify-between items-center mb-8">
                            <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-stone-100 rounded-full transition-all text-[#3E2723]"><i data-lucide="chevron-left"></i></button>
                            <h3 class="font-black text-[#3E2723] text-2xl">${year}å¹´ ${month+1}æœˆ</h3>
                            <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-stone-100 rounded-full transition-all text-[#3E2723]"><i data-lucide="chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2 md:gap-4">
                            ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => `<div class="text-center text-[10px] font-black text-stone-400 uppercase pb-2">${d}</div>`).join('')}
                            ${Array.from({length: new Date(year, month, 1).getDay()}).map(() => `<div></div>`).join('')}
                            ${Array.from({length: daysInMonth}).map((_, i) => {
                                const day = i + 1;
                                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                const count = records.filter(r => r.date === dStr).length;
                                
                                // è‰²å½©å±¤æ¬¡é‚è¼¯
                                let bgColor = 'bg-stone-50';
                                let textColor = 'text-stone-300';
                                
                                if (count === 1) {
                                    bgColor = 'bg-[#D7CCC8]'; // æ·ºè¤ (1åŠ‘)
                                    textColor = 'text-[#3E2723]';
                                } else if (count === 2) {
                                    bgColor = 'bg-[#A1887F]'; // ä¸­è¤ (2åŠ‘)
                                    textColor = 'text-white';
                                } else if (count === 3) {
                                    bgColor = 'bg-[#4E342E]'; // æ·±è¤ (3åŠ‘)
                                    textColor = 'text-white';
                                } else if (count >= 4) {
                                    bgColor = 'bg-red-700'; // äº®ç´… (4åŠ‘ä»¥ä¸Šè­¦å‘Š)
                                    textColor = 'text-white';
                                }

                                return `<div class="aspect-square flex flex-col items-center justify-center rounded-xl md:rounded-2xl text-xs md:text-base font-black border ${bgColor} ${textColor} border-stone-100 shadow-sm transition-all active:scale-95">
                                    <span>${day}</span>
                                    ${count > 0 ? `<span class="text-[8px] md:text-[10px] mt-0.5 font-black">${count}åŠ‘</span>` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                        <div class="mt-8 flex justify-center gap-4 text-[9px] font-black text-stone-400">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#D7CCC8] rounded-sm"></div>1åŠ‘</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#A1887F] rounded-sm"></div>2åŠ‘</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-[#4E342E] rounded-sm"></div>3åŠ‘</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-700 rounded-sm"></div>4åŠ‘+</div>
                        </div>
                    </div>`;
            } else if (activeTab === 'statistics') {
                const topShops = stats.allShops.slice(0, 5);
                const podiumData = [topShops[1] || ["-", 0], topShops[0] || ["-", 0], topShops[2] || ["-", 0]];
                content.innerHTML = `
                    <div class="space-y-6 animate-fadeIn pb-10">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-[#4D548C] p-5 rounded-3xl text-white text-center shadow-xl border-b-4 border-black/10">
                                <p class="text-[9px] font-black opacity-60 uppercase tracking-tighter">å¹´åº¦ç¸½åŠ‘é‡ / Dose</p>
                                <span class="text-2xl font-black">${stats.yDose} æ¯</span>
                            </div>
                            <div class="bg-[#8E4A4A] p-5 rounded-3xl text-white text-center shadow-xl border-b-4 border-black/10">
                                <p class="text-[9px] font-black opacity-60 uppercase tracking-tighter">å¹´åº¦ç¸½èŠ±è²» / Cost</p>
                                <span class="text-2xl font-black">$${stats.yCost}</span>
                            </div>
                            <div class="bg-[#4A6E4D] p-5 rounded-3xl text-white text-center shadow-xl border-b-4 border-black/10">
                                <p class="text-[9px] font-black opacity-60 uppercase tracking-tighter">å¹´åº¦å»¢æ£„ç‰©(ç’°ä¿æ¯) / Waste</p>
                                <span class="text-2xl font-black">${stats.yWaste} ä»¶</span>
                            </div>
                            <div class="bg-[#5C4D73] p-5 rounded-3xl text-white text-center shadow-xl border-b-4 border-black/10">
                                <p class="text-[9px] font-black opacity-60 uppercase tracking-tighter">å¹´åº¦å¥ä¿ç”³å ± / Ins</p>
                                <span class="text-2xl font-black">${stats.yIns} æ¯</span>
                            </div>
                        </div>
                        <section class="bg-white p-6 rounded-[2.5rem] border border-stone-200 shadow-lg">
                            <h3 class="font-black text-[#3E2723] text-[10px] uppercase text-center mb-16 tracking-widest opacity-60">å¹´åº¦è¨ºç™‚æ‰€æ’ä½è³½ / Podium</h3>
                            <div class="flex items-end justify-center gap-2 h-44">
                                <div class="flex flex-col items-center flex-1">
                                    <div class="text-[9px] font-black text-stone-500 mb-2 truncate w-full text-center px-1">${podiumData[0][0]}</div>
                                    <div class="w-full bg-[#E0D8C8] rounded-t-2xl flex flex-col items-center justify-center h-[55%] border-x-2 border-t-2 border-[#4E342E]"><span class="text-lg font-black text-[#4E342E]">2</span></div>
                                </div>
                                <div class="flex flex-col items-center flex-[1.3] relative">
                                    <div class="absolute -top-[100px] w-24 h-24 trophy-anim"><svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg"><path d="M10,20 L20,10 M80,10 L90,20 M15,80 L5,90 M85,90 L95,80" stroke="#F59E0B" stroke-width="3" stroke-linecap="round" /><path d="M30,30 C30,20 70,20 70,30 L65,65 C65,75 35,75 35,65 Z" fill="#FBBF24" stroke="#4E342E" stroke-width="4" /><path d="M30,35 H20 C15,35 15,50 20,50 H32" fill="none" stroke="#4E342E" stroke-width="4" stroke-linecap="round" /><path d="M70,35 H80 C85,35 85,50 80,50 H68" fill="none" stroke="#4E342E" stroke-width="4" stroke-linecap="round" /><rect x="35" y="70" width="30" height="8" fill="#D97706" stroke="#4E342E" stroke-width="4" /><rect x="25" y="78" width="50" height="10" rx="2" fill="#4E342E" /></svg></div>
                                    <div class="text-[11px] font-black text-[#3E2723] mb-2 truncate w-full text-center px-2 font-bold">${podiumData[1][0]}</div>
                                    <div class="w-full bg-[#3E2723] rounded-t-2xl flex flex-col items-center justify-center h-[95%] border-x-2 border-t-2 border-[#1a110e] shadow-xl"><span class="text-3xl font-black text-white">1</span></div>
                                </div>
                                <div class="flex flex-col items-center flex-1">
                                    <div class="text-[9px] font-black text-stone-500 mb-2 truncate w-full text-center px-1">${podiumData[2][0]}</div>
                                    <div class="w-full bg-[#D7CCC8]/60 rounded-t-2xl flex flex-col items-center justify-center h-[35%] border-x-2 border-t-2 border-[#4E342E]"><span class="text-base font-black text-[#4E342E]">3</span></div>
                                </div>
                            </div>
                        </section>
                        <section class="bg-white p-6 rounded-[2.5rem] border border-stone-200 shadow-lg">
                            <h3 class="font-black text-[#3E2723] text-[10px] uppercase mb-6 tracking-widest opacity-60">çœ‹è¨ºæ¬¡æ•¸çµ±è¨ˆ / Clinic Frequency</h3>
                            <div class="space-y-4">
                                ${topShops.length > 0 ? topShops.map(([name, count], idx) => {
                                    const percent = (count / (topShops[0][1] || 1)) * 100;
                                    return `<div class="flex flex-col"><div class="flex justify-between text-[10px] font-black text-stone-600 mb-1 px-1"><span>${idx+1}. ${name}</span><span class="opacity-50">${count} æ¬¡</span></div><div class="w-full bg-stone-50 h-4 rounded-full overflow-hidden border border-stone-100 p-0.5 shadow-inner"><div class="h-full bg-[#3E2723] rounded-full transition-all duration-1000" style="width: ${percent}%"></div></div></div>`}).join('') : '<p class="text-center py-10 text-[10px] font-black opacity-30 uppercase">ç›®å‰ç„¡æ•¸æ“š</p>'}
                            </div>
                        </section>
                    </div>`;
            } else if (activeTab === 'reports') {
                content.innerHTML = `
                    <div class="space-y-6 animate-fadeIn pb-10">
                        <section class="bg-white p-8 rounded-[2.5rem] border border-stone-200 shadow-lg text-center">
                            <div class="mb-6">
                                <i data-lucide="archive" size="48" class="mx-auto text-[#3E2723] opacity-80"></i>
                            </div>
                            <h3 class="font-black text-[#3E2723] text-lg uppercase mb-2">è‡¨åºŠæ•¸æ“šå ±è¡¨ / Reports</h3>
                            <p class="text-xs text-stone-400 font-bold mb-8">ä¸‹è¼‰æ‚¨çš„ç—…ä¾‹ç´€éŒ„é€²è¡Œå­˜æª”èˆ‡åˆ†æ</p>
                            
                            <div class="space-y-3 text-left">
                                <button onclick="exportToCSV()" class="w-full flex items-center justify-between bg-[#047857] text-white p-5 rounded-3xl font-black text-sm shadow-xl active:scale-95 transition-all">
                                    <div class="flex items-center gap-3"><i data-lucide="file-spreadsheet"></i> åŒ¯å‡º CSV å ±è¡¨</div>
                                    <i data-lucide="download"></i>
                                </button>
                                <button onclick="exportToJSON()" class="w-full flex items-center justify-between bg-[#3E2723] text-white p-5 rounded-3xl font-black text-sm shadow-xl active:scale-95 transition-all">
                                    <div class="flex items-center gap-3"><i data-lucide="database"></i> å‚™ä»½ JSON åŸå§‹æª”</div>
                                    <i data-lucide="download"></i>
                                </button>
                            </div>
                            
                            <div class="mt-8 pt-6 border-t border-dashed border-stone-200">
                                <p class="text-[10px] text-stone-400 font-bold italic">CSV æª”å¯ç”¨ Excel é–‹å•Ÿï¼›JSON æª”é©åˆå·¥ç¨‹å‚™ä»½ã€‚</p>
                            </div>
                        </section>
                    </div>`;
            }
            initIcons();
        }

        function editRecord(index) {
            editingIndex = index;
            const data = records[index];
            currentDate = data.date; 
            currentIce = data.ice; 
            currentSugar = data.sugar; 
            currentEco = data.eco; 
            currentIns = data.insurance;
            activeTab = 'prescribe'; 
            render(); 
            setTimeout(() => {
                const datePicker = document.getElementById('input-date');
                if(datePicker) datePicker.value = currentDate;
                const sponsorField = document.getElementById('sponsor-field');
                if (sponsorField && currentIns) sponsorField.classList.add('show');
            }, 10);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() { editingIndex = null; resetFormState(); render(); }
        function deleteRecord(index) { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç—…ä¾‹ç´€éŒ„å—ï¼Ÿ')) { records.splice(index, 1); saveRecords(); } }
        
        function setOption(t, v) { 
            if(t === 'ice') currentIce = v; 
            if(t === 'sugar') currentSugar = v; 
            if(t === 'eco') currentEco = v; 
            if(t === 'ins') {
                currentIns = v;
                const sponsorField = document.getElementById('sponsor-field');
                if (sponsorField) {
                    if (v) sponsorField.classList.add('show');
                    else sponsorField.classList.remove('show');
                }
            }
            render(); 
        }

        function saveCurrentRecord() {
            const shop = document.getElementById('input-shop').value.trim();
            const drink = document.getElementById('input-drink').value.trim();
            const costInput = document.getElementById('input-cost');
            const cost = costInput ? (costInput.value || 0) : 0;
            const sponsor = currentIns ? document.getElementById('input-sponsor').value.trim() : "";

            if(!shop || !drink) { alert('è«‹å®Œæ•´å¡«å¯«è¨ºç™‚æ‰€èˆ‡è—¥åŠ‘åç¨±'); return; }
            
            spawnSnowEffect();
            const newRecord = { 
                date: currentDate, 
                shop, drink, 
                cost: parseInt(cost), 
                ice: currentIce, 
                sugar: currentSugar, 
                eco: currentEco, 
                insurance: currentIns,
                sponsor: sponsor
            };

            setTimeout(() => {
                if(editingIndex !== null) { records[editingIndex] = newRecord; editingIndex = null; } 
                else { records.push(newRecord); }
                saveRecords(); 
                resetFormState(); 
                switchTab('history');
            }, 800);
        }
        window.onload = render;
    </script>
</body>
</html>

